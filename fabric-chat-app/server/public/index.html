<!DOCTYPE html>
<html>
<head>
    <title>Decentralized Chat</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        #chat-box { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .message { margin-bottom: 10px; padding: 8px; background: #f0f0f0; border-radius: 4px; }
        .meta { font-size: 0.8em; color: #666; }
        input { width: 70%; padding: 10px; }
        button { width: 25%; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h2>ðŸ”— Hyperledger Chat</h2>
    <div id="chat-box">Loading history...</div>
    <input type="text" id="msgInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>

    <script>
        const ROOM_ID = 'room1';
        
        // 1. Fetch History on Load
        async function loadHistory() {
            const res = await fetch(`/api/history/${ROOM_ID}`);
            const data = await res.json();
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            
            data.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message';
                div.innerHTML = `<strong>${msg.userId}</strong>: ${msg.content} <br><span class="meta">${new Date(msg.timestamp).toLocaleString()}</span>`;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 2. Send Message
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const content = input.value;
            if (!content) return;

            input.value = 'Sending...';
            input.disabled = true;

            await fetch('/api/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ roomId: ROOM_ID, content: content })
            });

            input.value = '';
            input.disabled = false;
            loadHistory(); // Refresh to see new message
        }

        // Initial Load
        loadHistory();
    </script>
</body>
</html>