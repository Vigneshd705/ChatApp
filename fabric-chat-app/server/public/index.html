<!DOCTYPE html>
<html>
<head>
    <title>Fabric Messenger</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: #f4f4f9; }
        
        /* Sidebar */
        #sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; display: flex; flex-direction: column; }
        #sidebar h3 { margin-top: 0; }
        .user-item, .group-item { padding: 10px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; }
        .user-item:hover, .group-item:hover { background: #34495e; }
        .active { background: #1abc9c; }

        /* Main Chat */
        #main { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        #chat-header { font-size: 1.5rem; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        #chat-history { flex: 1; overflow-y: scroll; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #input-area { margin-top: 20px; display: flex; }
        input { flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; outline: none; }
        button { padding: 0 20px; background: #1abc9c; color: white; border: none; border-radius: 0 5px 5px 0; cursor: pointer; font-weight: bold; }

        /* Login Modal */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; }
        #login-box { background: white; padding: 40px; border-radius: 8px; text-align: center; width: 300px; }
        #login-box input { width: 90%; margin-bottom: 10px; border-radius: 5px; }
        #login-box button { width: 100%; border-radius: 5px; padding: 10px; }
        
        .msg { margin-bottom: 10px; }
        .msg-own { text-align: right; }
        .bubble { display: inline-block; padding: 10px 15px; border-radius: 20px; background: #ecf0f1; max-width: 70%; }
        .msg-own .bubble { background: #1abc9c; color: white; }
        .sender-name { font-size: 0.75rem; color: #7f8c8d; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="login-modal">
        <div id="login-box">
            <h2>Who are you?</h2>
            <input type="text" id="usernameInput" placeholder="Enter Username (e.g. Alice)" />
            <button onclick="login()">Login / Register</button>
            <p id="loginStatus" style="font-size: 0.8rem; color: #666;"></p>
        </div>
    </div>

    <div id="sidebar" style="display:none;">
        <h3>ðŸ‘¤ My Account</h3>
        <p id="currentUserDisplay" style="margin-bottom: 30px; opacity: 0.7;"></p>
        
        <h3>ðŸ’¬ Direct Messages</h3>
        <div id="userList">
            <div class="user-item" onclick="selectChat('Bob')">Bob</div>
            <div class="user-item" onclick="selectChat('Charlie')">Charlie</div>
        </div>

        <h3 style="margin-top: 30px;">ðŸ“¢ Groups</h3>
        <div id="groupList">
            <div class="group-item" onclick="selectGroup('General')"># General</div>
            <div class="group-item" onclick="selectGroup('DevTeam')"># DevTeam</div>
        </div>
    </div>

    <div id="main" style="display:none;">
        <div id="chat-header">Select a chat</div>
        <div id="chat-history"></div>
        <div id="input-area">
            <input type="text" id="msgContent" placeholder="Type a message..." />
            <button onclick="sendMessage()">SEND</button>
        </div>
    </div>

    <script>
        let CURRENT_USER = '';
        let CURRENT_ROOM = '';
        let IS_GROUP = false;

        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) return;

            const status = document.getElementById('loginStatus');
            status.innerText = 'Registering with Blockchain...';

            // 1. Register User on Server
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });

            if (res.ok || res.status === 400) { // 400 means already exists, which is fine
                CURRENT_USER = username;
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('main').style.display = 'flex';
                document.getElementById('currentUserDisplay').innerText = username;
            } else {
                status.innerText = 'Error registering user.';
            }
        }

        function selectChat(otherUser) {
            IS_GROUP = false;
            // Generate deterministic Room ID: "Alice_Bob"
            const participants = [CURRENT_USER, otherUser].sort(); 
            CURRENT_ROOM = participants.join('_');
            
            updateHeader(`Chat with ${otherUser}`);
            loadHistory();
        }

        function selectGroup(groupName) {
            IS_GROUP = true;
            CURRENT_ROOM = groupName; // Groups are just simple strings
            updateHeader(`# ${groupName}`);
            loadHistory();
        }

        function updateHeader(title) {
            document.getElementById('chat-header').innerText = title;
            // Highlight active (simple logic)
            document.querySelectorAll('.user-item, .group-item').forEach(el => el.classList.remove('active'));
        }

        async function loadHistory() {
            if (!CURRENT_ROOM) return;
            const chatBox = document.getElementById('chat-history');
            chatBox.innerHTML = 'Loading blockchain history...';

            const res = await fetch(`/api/history/${CURRENT_ROOM}`);
            const data = await res.json();
            
            chatBox.innerHTML = '';
            data.forEach(msg => {
                const isMine = msg.userId === CURRENT_USER;
                const div = document.createElement('div');
                div.className = `msg ${isMine ? 'msg-own' : ''}`;
                div.innerHTML = `
                    <div class="sender-name">${msg.userId}</div>
                    <div class="bubble">${msg.content}</div>
                `;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('msgContent');
            const content = input.value;
            if (!content || !CURRENT_ROOM) return;

            input.value = ''; // Clear early for UX
            
            await fetch('/api/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: CURRENT_USER, 
                    roomId: CURRENT_ROOM, 
                    content: content 
                })
            });

            loadHistory(); // Reload to see new message
        }
        
        // Auto-refresh every 3 seconds to see new messages
        setInterval(() => {
            if(CURRENT_ROOM) loadHistory();
        }, 3000);

    </script>
</body>
</html>